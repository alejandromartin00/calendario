<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Calendario Seguro</title>
<script type="module" src="firebase.js"></script>
<script type="module" src="calendar.js"></script>
</main>

<!-- 游댷 Aqu칤 pegas este script antes del cierre del body -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCL8E4uaco0TOG5riZx0G1IQuSSThZ3v1I",
    authDomain: "calendario-personal-87124.firebaseapp.com",
    databaseURL: "https://calendario-personal-87124-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "calendario-personal-87124",
    storageBucket: "calendario-personal-87124.firebasestorage.app",
    messagingSenderId: "642755937259",
    appId: "1:642755937259:web:e460da3671ddae8edbcfae",
    measurementId: "G-RZWY38Y2EB"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Guardar un dato de prueba
  function guardarDato() {
    set(ref(db, 'usuarios/alejandro'), {
      nombre: "Alejandro",
      mensaje: "Funciona!"
    });
  }

  guardarDato();
  // Inicializa Firebase
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Prueba de escritura
  set(ref(db, 'test/'), { mensaje: 'Hola, funciona!' })
    .then(() => console.log("Dato guardado correctamente"))
    .catch(err => console.error("Error guardando:", err));

  // Prueba de lectura
  get(ref(db, 'test/'))
    .then(snapshot => {
      if(snapshot.exists()) console.log("Dato le칤do:", snapshot.val());
      else console.log("No hay datos");
    })
    .catch(err => console.error("Error leyendo:", err));
</script>
</script>
</script>


<style>
body{font-family:Segoe UI,Tahoma,Verdana,sans-serif;margin:0;background:#e0f0ff;color:#333;}
.overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:9999;}
.card{background:#fff;padding:22px;border-radius:12px;max-width:420px;width:92%;box-shadow:0 10px 30px rgba(0,0,0,0.2);text-align:center;}
.card h2{margin:0 0 12px;font-size:20px;color:#007aff}
.card input{width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;margin:8px 0;font-size:15px}
.card button{padding:10px 14px;border-radius:8px;border:none;background:#007aff;color:#fff;cursor:pointer}
.card small{display:block;margin-top:8px;color:#666}
.hidden{display:none}

/* Calendar */
.wrap { max-width: 1000px; margin:20px auto; padding:20px; background:#fff; border-radius:16px; box-shadow:0 8px 25px rgba(0,0,0,0.15); transition: all 0.3s ease; }
h1,h2 { text-align:center; color:#007aff; margin-bottom:12px; }
#monthLabel{ text-align:center;font-size:28px;font-weight:bold;color:#000;margin-bottom:12px; }
.calendar-month, .calendar-week { display:grid; grid-template-columns:repeat(7,1fr); gap:6px; margin-bottom:20px; }
.day, .week-day{ background:#f0f8ff;border-radius:12px;min-height:70px;display:flex;flex-direction:column;align-items:flex-start;padding:6px;font-size:12px;transition:transform .2s,background .3s;position:relative }
.day:hover, .week-day:hover{transform:translateY(-3px);background:#cfe6ff}
.day.today, .week-day.today{background:#007aff;color:#fff;font-weight:bold}
.tasks-preview{font-size:10px;color:#005f99;margin-top:4px;overflow:hidden;max-height:40px}
.days-header{display:grid;grid-template-columns:repeat(7,1fr);margin-bottom:6px;font-weight:bold;text-align:center;color:#007aff}
.add-task{display:flex;gap:6px;margin-bottom:20px}
input[type=text],input[type=number]{padding:8px;border-radius:8px;border:1px solid #ccc;font-size:14px}
input[type=text]{flex:1}
button.primary{padding:8px 12px;border-radius:8px;background:#007aff;color:#fff;border:none;cursor:pointer}
button.primary:hover{background:#005fcc}
button.logout{background:#e74c3c;color:#fff;padding:8px 10px;border-radius:8px;border:none;cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ccc;padding:8px;text-align:center}
th{background:#007aff;color:#fff}
td input{width:90%;border:none;border-radius:4px;padding:4px;text-align:center}
</style>
</head>
<body>

<div id="overlay" class="overlay">
  <div class="card">
    <h2 id="cardTitle">Acceder</h2>
    <div id="loginForm">
      <input id="loginUser" placeholder="Usuario" />
      <input id="loginPwd" type="password" placeholder="Contrase침a" />
      <button id="loginBtn">Entrar</button>
      <small id="loginMsg"></small>
    </div>
    <div id="registerForm" class="hidden">
      <input id="regUser" placeholder="Usuario" />
      <input id="regPwd" type="password" placeholder="Contrase침a (m칤n 4)" />
      <input id="regPwd2" type="password" placeholder="Repite contrase침a" />
      <button id="regBtn">Registrar</button>
      <small id="regMsg"></small>
    </div>
  </div>
</div>

<div id="app" class="hidden">
  <div class="wrap">
    <h1>Calendario Completo</h1>
    <h2 id="monthLabel"></h2>
    <div class="days-header" id="monthDaysHeader"></div>
    <div class="calendar-month" id="calendarMonth"></div>
    <div class="add-task">
      <input type="text" id="monthTaskInput" placeholder="Tarea / Examen / Trabajo">
      <input type="number" id="monthTaskDay" min="1" max="31" placeholder="D칤a">
      <button id="addMonthTaskBtn" class="primary">A침adir</button>
      <button id="logoutBtn" class="logout">Cerrar sesi칩n</button>
    </div>
    <h2>Calendario Semanal</h2>
    <div class="calendar-week" id="calendarWeek"></div>
    <h2>Horario de Clases</h2>
    <table>
      <tr><th>Hora\D칤a</th><th>Lunes</th><th>Martes</th><th>Mi칠rcoles</th><th>Jueves</th><th>Viernes</th></tr>
      <tr><td>08:00-09:00</td><td><input></td><td><input></td><td><input></td><td><input></td><td><input></td></tr>
      <tr><td>09:00-10:00</td><td><input></td><td><input></td><td><input></td><td><input></td><td><input></td></tr>
    </table>
  </div>
</div>

<script>
async function sha256Hex(str){const enc=new TextEncoder();const data=enc.encode(str);const hash=await crypto.subtle.digest('SHA-256',data);return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('')}
function randSalt(len=12){const arr=new Uint8Array(len);crypto.getRandomValues(arr);return Array.from(arr).map(n=>n.toString(16).padStart(2,'0')).join('')}

const overlay=document.getElementById('overlay'), app=document.getElementById('app');
const loginForm=document.getElementById('loginForm'), registerForm=document.getElementById('registerForm');
const cardTitle=document.getElementById('cardTitle');
const loginUser=document.getElementById('loginUser'), loginPwd=document.getElementById('loginPwd'), loginBtn=document.getElementById('loginBtn'), loginMsg=document.getElementById('loginMsg');
const regUser=document.getElementById('regUser'), regPwd=document.getElementById('regPwd'), regPwd2=document.getElementById('regPwd2'), regBtn=document.getElementById('regBtn'), regMsg=document.getElementById('regMsg');
const logoutBtn=document.getElementById('logoutBtn');

const USERS_KEY='cal_users';
function getUsers(){return JSON.parse(localStorage.getItem(USERS_KEY)||'[]')}
function saveUsers(u){localStorage.setItem(USERS_KEY,JSON.stringify(u))}
function showApp(){overlay.style.display='none';app.classList.remove('hidden');initCalendar();}
function showOverlay(){overlay.style.display='flex';app.classList.add('hidden');}

/* Registro y login */
if(getUsers().length===0){loginForm.classList.add('hidden');registerForm.classList.remove('hidden');cardTitle.textContent='Registrar primer usuario';}

regBtn.addEventListener('click',async ()=>{
  regMsg.textContent=''; const user=regUser.value.trim(); const p1=regPwd.value.trim(); const p2=regPwd2.value.trim();
  if(user.length<1){regMsg.textContent='Usuario vac칤o';return;}
  if(p1.length<4){regMsg.textContent='Contrase침a muy corta';return;}
  if(p1!==p2){regMsg.textContent='No coinciden';return;}
  const salt=randSalt(), hash=await sha256Hex(p1+salt);
  const users=getUsers(); users.push({username:user,salt,hash}); saveUsers(users);
  regUser.value='';regPwd.value='';regPwd2.value='';regMsg.textContent='Usuario creado';
  loginForm.classList.remove('hidden'); registerForm.classList.add('hidden'); cardTitle.textContent='Acceder';
});

loginBtn.addEventListener('click',async ()=>{
  loginMsg.textContent=''; const user=loginUser.value.trim(); const pwd=loginPwd.value.trim();
  const u=getUsers().find(x=>x.username===user);
  if(!u){loginMsg.textContent='Usuario no existe';return;}
  const h=await sha256Hex(pwd+u.salt);
  if(h===u.hash){loginUser.value='';loginPwd.value='';showApp();} else loginMsg.textContent='Contrase침a incorrecta';
});

logoutBtn.addEventListener('click',()=>{showOverlay();loginMsg.textContent='';loginUser.value='';loginPwd.value='';});

/* Calendario */
function initCalendar(){
  const monthLabel=document.getElementById('monthLabel');
  const monthDaysHeader=document.getElementById('monthDaysHeader');
  const calendarMonth=document.getElementById('calendarMonth');
  const calendarWeek=document.getElementById('calendarWeek');
  const monthTaskInput=document.getElementById('monthTaskInput');
  const monthTaskDay=document.getElementById('monthTaskDay');
  const addMonthTaskBtn=document.getElementById('addMonthTaskBtn');
  const currentDate=new Date();
  let monthDate=new Date(currentDate.getFullYear(),currentDate.getMonth(),1);

  const dayNames=['L','M','X','J','V','S','D'];
  monthDaysHeader.innerHTML=''; dayNames.forEach(d=>{const div=document.createElement('div');div.style.textAlign='center';div.textContent=d;monthDaysHeader.appendChild(div)});

  function loadTasks(){const data=localStorage.getItem('tasks'); return data?JSON.parse(data):[]}
  function saveTasks(tasks){localStorage.setItem('tasks',JSON.stringify(tasks))}

  function renderMonthly(){
    calendarMonth.innerHTML='';
    const year=monthDate.getFullYear(), month=monthDate.getMonth();
    monthLabel.textContent=monthDate.toLocaleDateString(undefined,{month:'long',year:'numeric'});
    const firstDay=new Date(year,month,1), lastDay=new Date(year,month+1,0);
    const pad=(firstDay.getDay()+6)%7;
    for(let i=0;i<pad;i++) calendarMonth.appendChild(document.createElement('div'));
    for(let d=1;d<=lastDay.getDate();d++){
      const dayDiv=document.createElement('div'); dayDiv.className='day'; dayDiv.textContent=d;
      if(new Date(year,month,d).toDateString()===currentDate.toDateString()) dayDiv.classList.add('today');
      const tasks=loadTasks().filter(t=>t.year===year && t.month===month && t.day===d);
      if(tasks.length>0){const tDiv=document.createElement('div');tDiv.className='tasks-preview';tDiv.textContent=tasks.map(t=>t.text).join(', ');dayDiv.appendChild(tDiv);}
      calendarMonth.appendChild(dayDiv);
    }
    renderWeekly();
  }

  addMonthTaskBtn.addEventListener('click',()=>{
    const text=monthTaskInput.value.trim(), day=parseInt(monthTaskDay.value);
    if(!text || !day) return;
    const tasks=loadTasks();
    tasks.push({text,year:monthDate.getFullYear(),month:monthDate.getMonth(),day});
    saveTasks(tasks); monthTaskInput.value=''; monthTaskDay.value=''; renderMonthly();
  });

  function renderWeekly(){
    calendarWeek.innerHTML='';
    const monday=new Date(currentDate); const dayOfWeek=monday.getDay()==0?7:monday.getDay(); monday.setDate(currentDate.getDate()-dayOfWeek+1);
    for(let i=0;i<7;i++){
      const day=new Date(monday); day.setDate(monday.getDate()+i);
      const div=document.createElement('div'); div.className='week-day'; div.textContent=`${day.getDate()}/${day.getMonth()+1}`;
      if(day.toDateString()===currentDate.toDateString()) div.classList.add('today');
      const tasks=loadTasks().filter(t=>t.year===monthDate.getFullYear() && t.month===monthDate.getMonth() && t.day===day.getDate());
      tasks.forEach(t=>{const tDiv=document.createElement('div');tDiv.className='tasks-preview';tDiv.textContent=t.text;div.appendChild(tDiv)});
      calendarWeek.appendChild(div);
    }
  }

  renderMonthly();
  setInterval(()=>{
    const today=new Date();
    if(today.getMonth()!==monthDate.getMonth() || today.getFullYear()!==monthDate.getFullYear()){
      monthDate=new Date(today.getFullYear(),today.getMonth(),1);
      renderMonthly();
    }
  },60000);
}
</script>
</body>
</html>
